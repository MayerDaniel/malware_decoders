'''
Written by Jason Reaves - @sysopfb
Free to use, attribute properly.

'''
import pefile
import sys
import re

def is_printable_string(a1):
	return all(ord(char) < 128 for char in a1)

def s_decode(key, a1):
	ret = ""
	for i in range(len(a1)):
		ret += chr((a1[i] - key[i % len(key) ] & 0xff))
	return ret
		

def decoder(pe_data):
	pe = pefile.PE(data=pe_data)
	conf = {}
	data_sect = None
	urls = []
	strings = []
	for sect in pe.sections:
		if '.data' in sect.Name:
			data_sect = sect.get_data()
	if data_sect != None:
		matches = re.findall('''[a-f0-9]{32}''', data_sect)
		if matches == []:
			print("No key matches found")
		else:
			key = bytearray(matches[0][1:]+'\x00')
			items = re.split('\x00+', data_sect)
			items = filter(lambda x: len(x) > 1, items)
			for s in items:
				temp = s_decode(key,bytearray(s))
				strings.append(temp)
				if 'http://' in temp or 'https://' in temp:
					urls.append(temp)
	
	conf['strings'] = filter(is_printable_string, strings)
	conf['urls'] = urls
	return conf
	
if __name__ == "__main__":
	data = open(sys.argv[1], 'rb').read()
	t = decoder(data)
	print(t)
	
